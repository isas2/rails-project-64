# Коллективный блог

## 0.4.0 (06.08.2024)

### Изменения

* https://github.com/isas2/rails-project-64/blob/fdc696aec8ec655227ccbdcc510668c2c3c3ea4c/app/controllers/posts_controller.rb#L51 - зачем так сложно, опять же. public/404 отрендерится автомагически в проде на RecordNotFound или несуществующий роут. В posts#show всё же работает отлично - https://ror.zabedu.ru/posts/15. Вот в доке про это https://guides.rubyonrails.org/v6.0.2.1/action_controller_overview.html#rescue

  - Это у меня из-за неопытности такое, не прочувствовал еще отличий dev и prod... В среде dev это приводило к ошибке, от которой естественно хотелось избавиться.

* https://github.com/isas2/rails-project-64/blob/fdc696aec8ec655227ccbdcc510668c2c3c3ea4c/CHANGELOG.md?plain=1#L15 - тут может я не очень понятно выразилась. Запросы к БД должны находиться в коде контроллера. Вьюхам же должно доставаться минимум логики и работы с БД, желательно вообще никакой. При таком разделении код становится структурированным и его проще тестировать. То, что сам запрос к БД выполнится на этапе рендеринга - это нормально, с этим мы не пытаемся бороться

* https://github.com/isas2/rails-project-64/blob/fdc696aec8ec655227ccbdcc510668c2c3c3ea4c/CHANGELOG.md?plain=1#L41 - давай остановим наш спор на этом моменте. Я уже поняла, что не могу донести свою идею. Не вопрос, твой личный опыт сделает это лучше меня.

* Вот этот комментарий пропустил, похоже: https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/test/controllers/posts/likes_controller_test.rb#L9 - не используешь, а зря. Зачем в тесте на удаление создавать лайк, если можно взять его из фикстур?

  - Исправил

## 0.3.0 (06.07.2024)

### Изменения

* https://ror.zabedu.ru/posts/4/edit - всё ещё могу открыть форму редактирования чужого поста. При сохранении ничего не происходит. Должна быть понятная ошибка в обоих случаях или флэш-сообщение. И при удалении поста тоже. В третьем модуле как раз будет про права доступа и как с этим правильно поступать. Можно пройти занятие по acl и притащить pundit в проект. Но так как ты и так с ним будешь тренироваться в третьем проекте, то можно обойтись без него и отдавать 404 для чужих записей, это тоже нормальный подход (в таком случае, нет шансов даже узнать, есть ли вообще в системе запись с таким айдишником)

  - вот теперь понял о каком редактировании идёт речь )
  - доработал метод set_post

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/app/controllers/posts_controller.rb#L12 - includes имеет смысл для коллекций. Для одной сущности он ничего не изменит

  - в данном случае они добавлены для выполнения замечания: "выборки из БД должны быть в контроллере"
  - сейчас все данные формируются в контроллере, если эти includes убрать, то запросы к БД идут во время рендеринга страниц

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/app/views/posts/comments/_index.html.slim#L8 - @post_comments является массивом хэшей, под капотом при рендеринге каждый элемент превращается в массив [key, value], из-за этого ты в партиале используешь first и last, и совершенно непонятно, что в них находится. Нагляднее будет сделать через итерацию

  - @post_comments.each do |comment, child_comments|
    = render 'post_comment', comment:, child_comments:
  - это я изучал рендер коллекций, но так код более чистый и наглядный, +

* https://github.com/isas2/rails-project-64/tree/7e2002f0c2d814f38537c7843215022cf64747aa/test/controllers/posts - идея в том, чтобы тесты так же были в отдельном нэймспэйсе, как и контроллеры. В глобальной перспективе это нужно для того, чтобы была возможность создавать контроллеры (и тесты) с одинаковым названием в разных нэймспейсах. То есть, Posts::CommentsControllerTest и Posts::LikesControllerTest

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/test/controllers/posts/comments_controller_test.rb#L9 - не используешь

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/test/controllers/posts/comments_controller_test.rb#L11 - в форме только поле content

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/test/controllers/posts/likes_controller_test.rb#L9 - не используешь, а зря. Зачем в тесте на удаление создавать лайк, если можно взять его из фикстур?

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/test/controllers/posts/likes_controller_test.rb#L13 - почем здесь айдишник лайка в post_id?

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/test/controllers/posts_controller_test.rb#L49 - для этого есть фикстуры. То же самое в тесте на удаление

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/test/controllers/posts_controller_test.rb#L52 - почему он created, если его обновляли?

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/CHANGELOG.md?plain=1#L15 - да я просто подкинула другой айдишник в урл в первом случае и отредактировала урл в html во втором. Фронт - это вообще не то, на что можно полагаться. Необходимо исходить из того, что пользователь может попытаться сделать что-то нехорошее доступными ему способами, поэтому все проверки и ограничения должны быть на бэке.

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/CHANGELOG.md?plain=1#L40 - вот именно поэтому only лучше. Он не позволит случайных ошибок, потому что забыли добавить в except. Но я не буду настаивать, это не критично, это скорее моя попытка рассказать, как проще писать поддерживаемый код

  - заканчивается планёрка и начальник говорит: "Николай, Евгений Степанович, Маша, Даша, Дмитрий Петрович и Александр могут идти...".
  - Что? Не проще ли будет: "Все кроме Пети свободны"?
  - при этом он может кого-то забыть назвать и них будут вопросы
  - Петя не будет точно уверен, что ему делать, он тоже будет задавать вопросы и уточнять 
  - начальник новый и может всех не помнить, но криворукого Петю он уже запомнил

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/CHANGELOG.md?plain=1#L50 - да, иногда комментарии необходимы. Но крайне редко. Желательно стремиться к тому, чтобы понятно было и без них. Почти всегда это решается именованием, вынесением понятных переменных и методов. Сравни

  - ```
    def editable?
    user.admin? || user.author?(post) || post.template?
    end
  
    ... return SomeError unless editable?
    ```
    и
    ```
    # here we check if user can edit post
    ... return Some Error if (user.role != "admin" && user.id != post.creator_id && post.template != true)
    ```

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/CHANGELOG.md?plain=1#L57 - это была ещё одна попытка рассказать, как писать поддерживаемый код. Это как в теории разбитых окон. Вот их два, а буквально через полгода их десять, потому что проще написать третий-пятый-десятый, чем разобраться с уже написанными. А если их нет (или договорились, что там только аутентификации и авторизация, что бывает чаще всего), то никто их и не добавляет. Rails Style Guide - это более низкоуровневые рекомендации, прямо скажем. В лекциях даются основы, а на проектах студенты учатся писать код, с которым можно жить долго и счастливо в реальном проекте

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/CHANGELOG.md?plain=1#L70 - имя поля автоматически подтянется, если у связи не переопределять class_name. Так что да, тут без вариантов

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/CHANGELOG.md?plain=1#L99 - к сожалению, нет

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/CHANGELOG.md?plain=1#L103 - да, бывает сложно, когда переменных несколько. Можно ещё раз обдумать их именование. Но привычка использовать инстанс-переменные в партиалах рано или поздно приведёт к гораздо большей головной боли

* https://github.com/isas2/rails-project-64/blob/7e2002f0c2d814f38537c7843215022cf64747aa/CHANGELOG.md?plain=1#L133 - да, вот тут прав, и мой комментарий не валиден. Урл будет строиться по имени модели

Если я не ответила на какой-то комментарий в changelog, значит там всё ок

Круто, что сам разобрался со всеми проблемами с js и победил button_to

## 0.2.0 (02.07.2024)

- Большое спасибо за все замечения, устраняя их улучшилось понимание некоторых особенностей работы.
- Из нерешённых вопросов остались button_to... и те решились
- Получилось, что не согласен с замечаниями, в которых встречается фраза "проще понимать". Значит моё "проще понимать" отличается.

### Изменения

* https://mycorpblog.onrender.com/posts/1 - могу редактировать не свой пост. Правда, теперь он уже мой :)
* Могу удалить чужой пост

  - нет 100% уверенности в месте ошибки: доступно редактирование/удаление через интерфейс или серез прямые запросы к контроллеру?
  - в интерфейсе не нашёл проблем, добавил ограничение редактирования в контроллере

* Двойной клик на лайк ставит два лайка от одного и того же пользователя (https://mycorpblog.onrender.com/posts/4).Двойной клик на анлайк переходит на https://mycorpblog.onrender.com/posts/4/likes/8 и падает ожидаемо с 404

  - Поведение воспроизвелось только в Chrome
  - Добавлена валидация: 
    ```
    validates :user_id, uniqueness: { scope: :post_id }
    ```
  - Однако документация говорит, что валидация не даёт 100% гарантии, поэтому добавил индекс:
    ```
    add_index :post_likes, %i[user_id post_id], unique: true
    ```
  - В итоге сделать двойной лайк нельзя на уровне БД, а вот если долбить по ссылке, то попасть на удаление несуществующего лайка ещё можно. В destroy заменил поиск по find на find_by с проверкой (&).

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/config/routes.rb#L7 - всегда лучше использовать белый список only, даже если он длиннее. Его проще понимать и поддерживать

  - Категорически не согласен!!! "Проще понимать" - обычно понятие субъективное.
    ```
    resources :posts, except: :index do
    # или
    resources :posts, only: %i[edit destroy new show update] do
    ```
  - Возможно, правильный вариант - договорённость внутри команды использовать определённый стиль, если надо
  - Ваши коллеги, читающие лекции, тоже придерживаются первого варианта.
  - Ну вот как так то!!! Поменял на only и сразу забыл create и сломал создание постов ((

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/models/category.rb#L4 - попытка удалить категорию из консоли должна упасть, так как пост обязательно принадлежит к ней. Ну и форма создания поста намекает, что категория обязательна. То же самое с has_many :posts в модели пользователя

  - Заменил на :restrict_with_exception
  - По пользователю наверное вопрос для ТЗ на следующую версию блога. И чтобы все посты не удалились, возможна отдельная процедура с передачей постов специальному 'Unknown' юзеру.

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts_controller.rb#L7 - я понимаю, что это всё от скаффолда, но вообще не принято засорять код такими очевидными комментариями. В целом комментарии - это последний отчаянный шаг, когда совсем не получается написать код понятно

  - Начсет этих комментариев - полностью согласен, убрал
  - А вот насчет "В целом комментарии..." - опять же не согласен полностью: не всегда понятный код = эффективный код; не всегда пишет и поддерживает приложение один и тот же человек/команда (а уровни у всех разные); а если работаешь над несколькими проектами на разных языках, то и свой код не всегда сразу понимаешь, т.к. процессы бывают сложные.
  - Ниже есть такая фраза: "это ещё один способ разобраться с проектом для того, кто видит его впервые". 

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts_controller.rb#L4 - то же самое, лучше использовать белый список only

  - no comments

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts_controller.rb#L5 - постарайся не использовать коллбэки before_action. Чем их меньше, тем проще и удобнее читать код. Когда их набирается десяток, становится очень сложно понимать, что происходит в конкретном экшне - надо сначала пройтись по всем колбэкам, отобрать нужные и удержать их все в голове, пока читаешь код самого экшна. Лучший вариант тут - явное определение переменных @post = set_post. Приемлемым считается использование коллбэков для авторизации и аутентификации, не более того

  - "Когда их набирается десяток..." - ПОЛНОСТЬЮ согласен, а тут их два...
  - Не нашел подобных рекомендаций в Rails Style Guide
  - Ваши коллеги, читающие лекции, научили их использовать

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts_controller.rb#L34 - нет смысла указывать формат, когда он один. Это касается всего файла и остальных контроллеров

  - Даже не задумывался что это и зачем, использовал как есть, почитал, исправил во всех контроллерах

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts_controller.rb#L9 - на главной посты должны быть сортированы от новых к старым. Кроме того, ты делаешь запрос за каждым пользователем, чтобы отобразить его почту (то же самое при отображении комментариев). Нужно подгрузить пользователей сразу, чтобы избежать проблемы N+1 запросов. К этой же проблеме приводит подсчёт количества лайков для каждого поста отдельным запросом к БД - это решается с помощью counter_cache

  - Очень важное замечание, видел все эти запросы, но почему-то не исправил
  - counter_cache запустил, но остался вопрос по имени поля: создавал и likes_count и post_likes_count, в итоге заработало только когда имя поля указал напрямую

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts_controller.rb#L71 - зачем тебе при обновлении изменять creator_id? В целом принято пользоваться ассоциациями @post = current_user.posts.build(post_params)

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts_controller.rb#L15 - используй ассоциацию, чтобы не назначать post_id отдельно. То же самое при создании комментариев и лайков
  
  - Согласен, так будет правильно, изначально было так, но оно не работало:
    ```ruby
    @post_comments = @post.comments
    @post_comment = @post.comments.build
    ```
  - Похоже, что в данном случае в @post_comments передаётся массив по ссылке. Т.е. у меня есть два комментария, я создаю через build третий и он сразу включается в массив @post_comments, полученный строкой выше и его тоже начинает рендерить, что уже неправильно и приводит к ошибке.
  - Однако, при добавлении любого метода: .where(...) или .order(...) данная конструкция уже работает как надо, наверное это уже другая ссылка
  - Исправил

* То же самое при создании комментариев и лайков

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts/likes_controller.rb#L18 - like = current_user.likes.find(params[:id]) и не нужно никаких условий. Ну не зря же ты объявил связи в моделях

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts/comments_controller.rb#L23 - зачем так сложно, если параметр можно назвать parent_id и всё будет просто работать

  - like

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/helpers/application_helper.rb#L10 - а зачем || type.to_s, бутстрап всё равно не сможет это как-то обработать

  - нашёл эту функцию в инете в таком виде

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/views/layouts/shared/_nav.html.slim#L6 - все тексты должны быть в локалях

  - исправил, есть ли инструмент, который ищет такие "потерянные" тексты автоматически?

* Общее замечание по вьюхам - не надо в партиалах использовать инстанс-переменные, это сильно усложняет их поддержку и использование, ты завязываешься на имена этих переменных и не всегда можно быстро понять, откуда они прилетели. Это становится актуально, когда один и тот же партиал начинают рендерить разные контроллеры. Используй локальные переменные и передавай их явно http://www.carlosramireziii.com/stop-using-instance-variables-in-partials.html

  - изначально так и было, была последовательная передача локальных переменных и в тот момент, когда совсем запутался - сделал оптимизацию, существенно сократило код и увеличило понимание происходящего

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/views/posts/index.html.slim#L15 - есть удобный метод truncate для этого

  - Спасибо! У меня даже записано спросить, есть ли какой-то готовый метод.

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/views/posts/show.html.slim#L26 - выборки из БД должны быть в контроллере. find_by отлично заменяет where(...).first. Но вообще должна быть валидация - один лайк на пост от юзверя

  - перенёс в контроллер, заменил на find_by
  - валидация уже сделана выше

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/views/posts/show.html.slim#L28 - а почему button_to, которая генерит целую форму, а не link_to? То же самое для удаления поста

  - И для кнопки 'Выход' тоже самое...
  - Это костыль, потому что по другому у меня не работает:
    ```
    link_to ... method: :delete
    # ругается No route matches [GET] "/users/sign_out"
    link_to ... data: { turbo_method: :delete }
    # просто не работает
    ```
  - Мои попытки разобраться и починить заканчивались тем, что переставили работать все остальные кнопки
  - В моём проекте где-то случился сбой, может зависимости какой-то не хватает, может что-то наоборот лишнее и сам я пока не починю, помощь приветствуется

* https://github.com/isas2/rails-project-64/tree/811001894311685510fd1ba9def07f76a7e2f073/app/views/posts/comments - root_form и children_form скажут гораздо больше, чем цифры

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/views/posts/comments/_post_comment.html.slim#L19 - так ты делаешь запрос за дочерними комментариями для каждого. Между тем, у ancestry есть удобный метод, который позволяет собрать всё дерево сразу, и дальше его нужно будет просто отрендерить

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/views/posts/comments/_form2.html.slim#L1 - simple_form_for([post, comment]) позволит не передавать урл отдельно

  - simple_form_for([post, comment]) - в моём случае генерирует путь post_post_comments_path, которого нет
  - возможно это решается "правильным" описанием маршрутов, но это пока не мой уровень )

* https://github.com/isas2/rails-project-64/tree/811001894311685510fd1ba9def07f76a7e2f073/test/fixtures - ты не пользуешься всеми записями, которые объявлены в фикстурах. В них стараются поддерживать минимально необходимый набор данных, чтобы упростить поддержку. MyString в значениях, конечно, допустимо, но вообще стараются заполнять фикстуры более реальными данными (желательно вообще рандомными с помощью faker) - это ещё один способ разобраться с проектом для того, кто видит его впервые

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/test/fixtures/users.yml#L7 - пользователь невалиден, в дальнейшем это может привести к очень странным багам в тестах

* https://github.com/isas2/rails-project-64/tree/811001894311685510fd1ba9def07f76a7e2f073/test/controllers - тесты должны повторять структуру проекта. Контроллеры лайков и комментов живут в отдельной папке, в тестах должно быть так же

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/test/controllers/posts_controller_test.rb#L24 - правильнее проверять, что сущность была не просто создана, а создана с переданными параметрами.

  - ```
    created_post = Post.find_by(params)
    assert created_post.present?
    ```
  - Для этого нужно создать её с данными, отличными от того, что в фикстурах. И откуда здесь creator_id, в форме нет такого поля (тот же вопрос при update)
  - Исправлено

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/test/controllers/posts_controller_test.rb#L42 - здесь нужно обновить сущность какими-то другими данными и проверить, что они изменились

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/test/controllers/posts_controller_test.rb#L47 - правильнее проверять, что конкретный пост был удален assert Post.find_by(id: @post.id) == nil. То же самое в тесте на удаление лайка

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/test/controllers/posts_controller_test.rb#L47 - те же самые замечания, что про создание поста. И непонятные post_id и user_id в параметрах

  - наверное речь про комментарии
  - по post_id и user_id есть вопрос:
    ```
    @post_comment = post.comments.build(comment_params)
    или
    @post_comment = current_user.comments.build(comment_params)
    ```
    Пошел по второму пути, но post_id в любом случае нужно добавлять
  - тест создания комментария доработал

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/test/controllers/likes_controller_test.rb#L15 - всё то же самое, параметров в этот экшн под ключом like вообще никаких не прилетает. Ну и не должен такой лайк быть создан, он уже есть в фикстурах


## 0.1.0 (20.06.2024)

Первый тестовый релиз блога
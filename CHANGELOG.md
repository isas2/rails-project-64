# Коллективный блог

## 0.2.0 (02.07.2024)

- Большое спасибо за все замечения, устраняя их улучшилось понимание некоторых особенностей работы.
- Из нерешённых вопросов остались button_to...
- Получилось, что не согласен с замечаниями, в которых встречается фраза "проще понимать". Значит моё "проще понимать" отличается.

### Изменения

* https://mycorpblog.onrender.com/posts/1 - могу редактировать не свой пост. Правда, теперь он уже мой :)
* Могу удалить чужой пост

  - нет 100% уверенности в месте ошибки: доступно редактирование/удаление через интерфейс или серез прямые запросы к контроллеру?
  - в интерфейсе не нашёл проблем, добавил ограничение редактирования в контроллере

* Двойной клик на лайк ставит два лайка от одного и того же пользователя (https://mycorpblog.onrender.com/posts/4).Двойной клик на анлайк переходит на https://mycorpblog.onrender.com/posts/4/likes/8 и падает ожидаемо с 404

  - Поведение воспроизвелось только в Chrome
  - Добавлена валидация: 
    ```
    validates :user_id, uniqueness: { scope: :post_id }
    ```
  - Однако документация говорит, что валидация не даёт 100% гарантии, поэтому добавил индекс:
    ```
    add_index :post_likes, %i[user_id post_id], unique: true
    ```
  - В итоге сделать двойной лайк нельзя на уровне БД, а вот если долбить по ссылке, то попасть на удаление несуществующего лайка ещё можно. В destroy заменил поиск по find на find_by с проверкой (&).

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/config/routes.rb#L7 - всегда лучше использовать белый список only, даже если он длиннее. Его проще понимать и поддерживать

  - Категорически не согласен!!! "Проще понимать" - обычно понятие субъективное.
    ```
    resources :posts, except: :index do
    # или
    resources :posts, only: %i[edit destroy new show update] do
    ```
  - Возможно, правильный вариант - договорённость внутри команды использовать определённый стиль, если надо
  - Ваши коллеги, читающие лекции, тоже придерживаются первого варианта.
  - Ну вот как так то!!! Поменял на only и сразу забыл create и сломал создание постов ((

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/models/category.rb#L4 - попытка удалить категорию из консоли должна упасть, так как пост обязательно принадлежит к ней. Ну и форма создания поста намекает, что категория обязательна. То же самое с has_many :posts в модели пользователя

  - Заменил на :restrict_with_exception
  - По пользователю наверное вопрос для ТЗ на следующую версию блога. И чтобы все посты не удалились, возможна отдельная процедура с передачей постов специальному 'Unknown' юзеру.

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts_controller.rb#L7 - я понимаю, что это всё от скаффолда, но вообще не принято засорять код такими очевидными комментариями. В целом комментарии - это последний отчаянный шаг, когда совсем не получается написать код понятно

  - Начсет этих комментариев - полностью согласен, убрал
  - А вот насчет "В целом комментарии..." - опять же не согласен полностью: не всегда понятный код = эффективный код; не всегда пишет и поддерживает приложение один и тот же человек/команда (а уровни у всех разные); а если работаешь над несколькими проектами на разных языках, то и свой код не всегда сразу понимаешь, т.к. процессы бывают сложные.
  - Ниже есть такая фраза: "это ещё один способ разобраться с проектом для того, кто видит его впервые". 

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts_controller.rb#L4 - то же самое, лучше использовать белый список only

  - no comments

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts_controller.rb#L5 - постарайся не использовать коллбэки before_action. Чем их меньше, тем проще и удобнее читать код. Когда их набирается десяток, становится очень сложно понимать, что происходит в конкретном экшне - надо сначала пройтись по всем колбэкам, отобрать нужные и удержать их все в голове, пока читаешь код самого экшна. Лучший вариант тут - явное определение переменных @post = set_post. Приемлемым считается использование коллбэков для авторизации и аутентификации, не более того

  - "Когда их набирается десяток..." - ПОЛНОСТЬЮ согласен, а тут их два...
  - Не нашел подобных рекомендаций в Rails Style Guide
  - Ваши коллеги, читающие лекции, научили их использовать

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts_controller.rb#L34 - нет смысла указывать формат, когда он один. Это касается всего файла и остальных контроллеров

  - Даже не задумывался что это и зачем, использовал как есть, почитал, исправил во всех контроллерах

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts_controller.rb#L9 - на главной посты должны быть сортированы от новых к старым. Кроме того, ты делаешь запрос за каждым пользователем, чтобы отобразить его почту (то же самое при отображении комментариев). Нужно подгрузить пользователей сразу, чтобы избежать проблемы N+1 запросов. К этой же проблеме приводит подсчёт количества лайков для каждого поста отдельным запросом к БД - это решается с помощью counter_cache

  - Очень важное замечание, видел все эти запросы, но почему-то не исправил
  - counter_cache запустил, но остался вопрос по имени поля: создавал и likes_count и post_likes_count, в итоге заработало только когда имя поля указал напрямую

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts_controller.rb#L71 - зачем тебе при обновлении изменять creator_id? В целом принято пользоваться ассоциациями @post = current_user.posts.build(post_params)

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts_controller.rb#L15 - используй ассоциацию, чтобы не назначать post_id отдельно. То же самое при создании комментариев и лайков
  
  - Согласен, так будет правильно, изначально было так, но оно не работало:
    ```ruby
    @post_comments = @post.comments
    @post_comment = @post.comments.build
    ```
  - Похоже, что в данном случае в @post_comments передаётся массив по ссылке. Т.е. у меня есть два комментария, я создаю через build третий и он сразу включается в массив @post_comments, полученный строкой выше и его тоже начинает рендерить, что уже неправильно и приводит к ошибке.
  - Однако, при добавлении любого метода: .where(...) или .order(...) данная конструкция уже работает как надо, наверное это уже другая ссылка
  - Исправил

* То же самое при создании комментариев и лайков

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts/likes_controller.rb#L18 - like = current_user.likes.find(params[:id]) и не нужно никаких условий. Ну не зря же ты объявил связи в моделях

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/controllers/posts/comments_controller.rb#L23 - зачем так сложно, если параметр можно назвать parent_id и всё будет просто работать

  - like

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/helpers/application_helper.rb#L10 - а зачем || type.to_s, бутстрап всё равно не сможет это как-то обработать

  - нашёл эту функцию в инете в таком виде

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/views/layouts/shared/_nav.html.slim#L6 - все тексты должны быть в локалях

  - исправил, есть ли инструмент, который ищет такие "потерянные" тексты автоматически?

* Общее замечание по вьюхам - не надо в партиалах использовать инстанс-переменные, это сильно усложняет их поддержку и использование, ты завязываешься на имена этих переменных и не всегда можно быстро понять, откуда они прилетели. Это становится актуально, когда один и тот же партиал начинают рендерить разные контроллеры. Используй локальные переменные и передавай их явно http://www.carlosramireziii.com/stop-using-instance-variables-in-partials.html

  - изначально так и было, была последовательная передача локальных переменных и в тот момент, когда совсем запутался - сделал оптимизацию, существенно сократило код и увеличило понимание происходящего

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/views/posts/index.html.slim#L15 - есть удобный метод truncate для этого

  - Спасибо! У меня даже записано спросить, есть ли какой-то готовый метод.

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/views/posts/show.html.slim#L26 - выборки из БД должны быть в контроллере. find_by отлично заменяет where(...).first. Но вообще должна быть валидация - один лайк на пост от юзверя

  - перенёс в контроллер, заменил на find_by
  - валидация уже сделана выше

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/views/posts/show.html.slim#L28 - а почему button_to, которая генерит целую форму, а не link_to? То же самое для удаления поста

  - И для кнопки 'Выход' тоже самое...
  - Это костыль, потому что по другому у меня не работает:
    ```
    link_to ... method: :delete
    # ругается No route matches [GET] "/users/sign_out"
    link_to ... data: { turbo_method: :delete }
    # просто не работает
    ```
  - Мои попытки разобраться и починить заканчивались тем, что переставили работать все остальные кнопки
  - В моём проекте где-то случился сбой, может зависимости какой-то не хватает, может что-то наоборот лишнее и сам я пока не починю, помощь приветствуется

* https://github.com/isas2/rails-project-64/tree/811001894311685510fd1ba9def07f76a7e2f073/app/views/posts/comments - root_form и children_form скажут гораздо больше, чем цифры

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/views/posts/comments/_post_comment.html.slim#L19 - так ты делаешь запрос за дочерними комментариями для каждого. Между тем, у ancestry есть удобный метод, который позволяет собрать всё дерево сразу, и дальше его нужно будет просто отрендерить

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/app/views/posts/comments/_form2.html.slim#L1 - simple_form_for([post, comment]) позволит не передавать урл отдельно

  - simple_form_for([post, comment]) - в моём случае генерирует путь post_post_comments_path, которого нет
  - возможно это решается "правильным" описанием маршрутов, но это пока не мой уровень )

* https://github.com/isas2/rails-project-64/tree/811001894311685510fd1ba9def07f76a7e2f073/test/fixtures - ты не пользуешься всеми записями, которые объявлены в фикстурах. В них стараются поддерживать минимально необходимый набор данных, чтобы упростить поддержку. MyString в значениях, конечно, допустимо, но вообще стараются заполнять фикстуры более реальными данными (желательно вообще рандомными с помощью faker) - это ещё один способ разобраться с проектом для того, кто видит его впервые

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/test/fixtures/users.yml#L7 - пользователь невалиден, в дальнейшем это может привести к очень странным багам в тестах

* https://github.com/isas2/rails-project-64/tree/811001894311685510fd1ba9def07f76a7e2f073/test/controllers - тесты должны повторять структуру проекта. Контроллеры лайков и комментов живут в отдельной папке, в тестах должно быть так же

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/test/controllers/posts_controller_test.rb#L24 - правильнее проверять, что сущность была не просто создана, а создана с переданными параметрами.

  - ```
    created_post = Post.find_by(params)
    assert created_post.present?
    ```
  - Для этого нужно создать её с данными, отличными от того, что в фикстурах. И откуда здесь creator_id, в форме нет такого поля (тот же вопрос при update)
  - Исправлено

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/test/controllers/posts_controller_test.rb#L42 - здесь нужно обновить сущность какими-то другими данными и проверить, что они изменились

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/test/controllers/posts_controller_test.rb#L47 - правильнее проверять, что конкретный пост был удален assert Post.find_by(id: @post.id) == nil. То же самое в тесте на удаление лайка

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/test/controllers/posts_controller_test.rb#L47 - те же самые замечания, что про создание поста. И непонятные post_id и user_id в параметрах

  - наверное речь про комментарии
  - по post_id и user_id есть вопрос:
    ```
    @post_comment = post.comments.build(comment_params)
    или
    @post_comment = current_user.comments.build(comment_params)
    ```
    Пошел по второму пути, но post_id в любом случае нужно добавлять
  - тест создания комментария доработал

* https://github.com/isas2/rails-project-64/blob/811001894311685510fd1ba9def07f76a7e2f073/test/controllers/likes_controller_test.rb#L15 - всё то же самое, параметров в этот экшн под ключом like вообще никаких не прилетает. Ну и не должен такой лайк быть создан, он уже есть в фикстурах


## 0.1.0 (20.06.2024)

Первый тестовый релиз блога